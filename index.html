<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Photo Resizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="number"],
    input[type="file"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
    }
    #resizeBtn, #downloadBtn {
      margin: 20px auto;
      display: block;
      padding: 10px 20px;
      font-size: 16px;
    }
    #downloadBtn {
      display: none;
    }
    .note {
      font-size: 0.9em;
      color: #555;
      text-align: center;
      margin-top: -10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Custom Photo Resizer</h1>
  <p class="note">
    Fill in the fields below. Provide either the width &amp; height range OR the exact dimensions (in inches @ dpi).<br>
    <strong>Do not fill both.</strong>
  </p>
  <div class="container">
    <!-- Column 1: Image Upload -->
    <div class="form-group">
      <label for="imageUpload">Upload Image</label>
      <input type="file" id="imageUpload" accept="image/*" />
    </div>
    <!-- Column 2: File Size Limits -->
    <div class="form-group">
      <label for="minSize">Min File Size (KB)</label>
      <input type="number" id="minSize" placeholder="e.g., 50" />
      <label for="maxSize">Max File Size (KB)</label>
      <input type="number" id="maxSize" placeholder="e.g., 300" />
    </div>
    <!-- Column 3: Width Range -->
    <div class="form-group">
      <label for="minWidth">Min Width (px)</label>
      <input type="number" id="minWidth" placeholder="e.g., 300" />
      <label for="maxWidth">Max Width (px)</label>
      <input type="number" id="maxWidth" placeholder="e.g., 600" />
    </div>
    <!-- Column 4: Height Range -->
    <div class="form-group">
      <label for="minHeight">Min Height (px)</label>
      <input type="number" id="minHeight" placeholder="e.g., 300" />
      <label for="maxHeight">Max Height (px)</label>
      <input type="number" id="maxHeight" placeholder="e.g., 600" />
    </div>
    <!-- Column 5: Exact Dimensions (Optional) -->
    <div class="form-group">
      <label for="dimensions">Exact Dimensions (inches @ dpi)</label>
      <input type="text" id="dimensions" placeholder="e.g., 2x2 @300" />
    </div>
  </div>
  <!-- Resize Button -->
  <button id="resizeBtn" disabled>Resize</button>
  <!-- Download Button (appears after resize) -->
  <button id="downloadBtn">Download Resized Image</button>
  
  <!-- Hidden Canvas to Process the Image -->
  <canvas id="canvas" style="display: none;"></canvas>

  <script>
    // Get references to our form elements.
    const imageUpload = document.getElementById('imageUpload');
    const minSize = document.getElementById('minSize');
    const maxSize = document.getElementById('maxSize');
    const minWidth = document.getElementById('minWidth');
    const maxWidth = document.getElementById('maxWidth');
    const minHeight = document.getElementById('minHeight');
    const maxHeight = document.getElementById('maxHeight');
    const dimensions = document.getElementById('dimensions');
    const resizeBtn = document.getElementById('resizeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const canvas = document.getElementById('canvas');

    let resizedImageDataURL = '';

    // Validate that required fields are filled.
    function validateInputs() {
      if (!imageUpload.files || imageUpload.files.length === 0) return false;
      if (!minSize.value || !maxSize.value) return false;
      // Check if either width/height range is provided or exact dimensions.
      const rangeProvided = minWidth.value && maxWidth.value && minHeight.value && maxHeight.value;
      const exactProvided = dimensions.value;
      if (!rangeProvided && !exactProvided) return false;
      return true;
    }

    // Enable or disable the Resize button based on input validation.
    function updateResizeButton() {
      resizeBtn.disabled = !validateInputs();
    }
    [imageUpload, minSize, maxSize, minWidth, maxWidth, minHeight, maxHeight, dimensions].forEach(input => {
      input.addEventListener('input', updateResizeButton);
    });

    // Function to estimate the size (in KB) of a Data URL.
    function dataURLSizeKB(dataURL) {
      const base64Str = dataURL.split(',')[1];
      const sizeInBytes = Math.floor((base64Str.length * 3) / 4);
      return sizeInBytes / 1024;
    }

    // Adjust the JPEG quality until the file size is within the user-specified limits.
    function getDataURLWithSizeConstraints(minKB, maxKB, callback) {
      let quality = 0.9; // Start with a high quality.
      const step = 0.05; // Quality adjustment step.
      let dataURL = canvas.toDataURL('image/jpeg', quality);
      let sizeKB = dataURLSizeKB(dataURL);

      // Lower quality if the file is too high.
      while (sizeKB > maxKB && quality > 0.1) {
        quality -= step;
        dataURL = canvas.toDataURL('image/jpeg', quality);
        sizeKB = dataURLSizeKB(dataURL);
      }

      // Increase quality if the file is too low.
      while (sizeKB < minKB && quality < 1.0) {
        quality += step;
        if (quality > 1.0) quality = 1.0;
        dataURL = canvas.toDataURL('image/jpeg', quality);
        sizeKB = dataURLSizeKB(dataURL);
        if (quality === 1.0) break;
      }
      callback(dataURL, quality, sizeKB);
    }

    // When the user clicks the Resize button.
    resizeBtn.addEventListener('click', function () {
      // Check if both the range and the exact dimension fields are filled.
      const rangeProvided = minWidth.value && maxWidth.value && minHeight.value && maxHeight.value;
      const exactProvided = dimensions.value;
      if (rangeProvided && exactProvided) {
        alert("Please provide either the width & height ranges or the exact dimensions (in inches @ dpi), not both.");
        return;
      }
      if (!validateInputs()) {
        alert('Please fill in all required fields.');
        return;
      }
      const file = imageUpload.files[0];
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.onload = function () {
          let newWidth, newHeight;
          if (exactProvided) {
            // Parse the format "widthxheight @dpi" (e.g., "2x2 @300")
            const parts = dimensions.value.split('@');
            if (parts.length === 2) {
              const dims = parts[0].trim().split('x');
              if (dims.length === 2) {
                const dpi = parseInt(parts[1].trim());
                const inchesWidth = parseFloat(dims[0]);
                const inchesHeight = parseFloat(dims[1]);
                newWidth = Math.round(inchesWidth * dpi);
                newHeight = Math.round(inchesHeight * dpi);
              }
            }
          } else {
            newWidth = parseInt(minWidth.value);
            newHeight = parseInt(minHeight.value);
          }
          // Resize the image using a hidden canvas.
          canvas.width = newWidth;
          canvas.height = newHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, newWidth, newHeight);

          // Adjust JPEG quality to meet file size constraints.
          getDataURLWithSizeConstraints(parseInt(minSize.value), parseInt(maxSize.value), function(dataURL, qualityUsed, finalSizeKB) {
            resizedImageDataURL = dataURL;
            downloadBtn.style.display = 'block';
            alert("Resize successful! Your image meets the size criteria. Final file size: " + finalSizeKB.toFixed(1) + " KB. Click the Download button to save your image.");
          });
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // When the user clicks the Download button.
    downloadBtn.addEventListener('click', function () {
      if (!resizedImageDataURL) return;
      const link = document.createElement('a');
      link.href = resizedImageDataURL;
      link.download = 'resized-image.jpg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
